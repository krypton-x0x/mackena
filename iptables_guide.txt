üìå –ß—Ç–æ —Ç–∞–∫–æ–µ iptables?
iptables ‚Äî —ç—Ç–æ —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–∞–∫–µ—Ç–æ–≤ –≤ Linux —á–µ—Ä–µ–∑ –ø–æ–¥—Å–∏—Å—Ç–µ–º—É netfilter.

üö® –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
filter ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é).

nat ‚Äî –¥–ª—è NAT, –ø–µ—Ä–µ–∞–¥—Ä–µ—Å–∞—Ü–∏–∏ –ø–æ—Ä—Ç–æ–≤.

mangle ‚Äî –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–∞–∫–µ—Ç–æ–≤ (TTL, QoS –∏ —Ç.–¥.).

raw ‚Äî –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏–∑ state tracking.

security ‚Äî –¥–ª—è SELinux.

üîó –¶–µ–ø–æ—á–∫–∏ (chains)
INPUT ‚Äî –≤—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫.

OUTPUT ‚Äî –∏—Å—Ö–æ–¥—è—â–∏–π.

FORWARD ‚Äî –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º—ã–π.

PREROUTING ‚Äî –¥–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ (–¥–ª—è NAT).

POSTROUTING ‚Äî –ø–æ—Å–ª–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ (–¥–ª—è NAT).

üß± –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã
bash
Copy
Edit
# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∞–≤–∏–ª–∞
iptables -L -n -v
iptables -t nat -L -n -v
iptables -t mangle -L -n -v

# –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ
iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# –í—Å—Ç–∞–≤–∏—Ç—å –≤ –Ω–∞—á–∞–ª–æ
iptables -I INPUT 1 -p tcp --dport 80 -j ACCEPT

# –£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –ø–æ –Ω–æ–º–µ—Ä—É
iptables -D INPUT 3

# –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø—Ä–∞–≤–∏–ª–∞
iptables -F

# –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ü–µ–ø–æ—á–∫–∏
iptables -X

# –°–±—Ä–æ—Å–∏—Ç—å —Å—á—ë—Ç—á–∏–∫–∏
iptables -Z

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞
iptables-save > /etc/iptables/rules.v4

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞
iptables-restore < /etc/iptables/rules.v4
üî• –ü—Ä–∏–º–µ—Ä—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∞–π—Ä–≤–æ–ª–∞
‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫—Ä—ã—Ç—å –≤—Å—ë
bash
Copy
Edit
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT
‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å –ª–æ–∫–∞–ª—Ö–æ—Å—Ç –∏ –≤—Ö–æ–¥ –ø–æ SSH
bash
Copy
Edit
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp --sport 22 -m conntrack --ctstate ESTABLISHED -j ACCEPT
‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å HTTP/HTTPS
bash
Copy
Edit
iptables -A INPUT -p tcp -m multiport --dports 80,443 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp --sport 80 -m conntrack --ctstate ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp --sport 443 -m conntrack --ctstate ESTABLISHED -j ACCEPT
‚úÖ –†–∞–∑—Ä–µ—à–∏—Ç—å ICMP (ping)
bash
Copy
Edit
iptables -A INPUT -p icmp -j ACCEPT
üì¶ NAT –∏ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤ (–Ω–∞ —à–ª—é–∑–µ)
bash
Copy
Edit
# –í–∫–ª—é—á–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é
echo 1 > /proc/sys/net/ipv4/ip_forward

# –ú–∞—Å–∫–∞—Ä–∞–¥–∏–Ω–≥ (NAT)
iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# –ü—Ä–æ–±—Ä–æ—Å 80 –ø–æ—Ä—Ç–∞ —Å –≤–Ω–µ—à–Ω–µ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to-destination 192.168.0.100:80
‚õë –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (stateful firewall)
bash
Copy
Edit
# –†–∞–∑—Ä–µ—à–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
Debian/Ubuntu:

bash
Copy
Edit
apt install iptables-persistent
iptables-save > /etc/iptables/rules.v4
Red Hat/CentOS:

bash
Copy
Edit
service iptables save
üß™ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
bash
Copy
Edit
iptables -S    # –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª –≤ –≤–∏–¥–µ –∫–æ–º–∞–Ω–¥
iptables -L -n -v --line-numbers  # –° –Ω–æ–º–µ—Ä–∞–º–∏ –ø—Ä–∞–≤–∏–ª
üõ° iptables + ipset (–¥–ª—è –±–æ–ª—å—à–æ–≥–æ —Å–ø–∏—Å–∫–∞ IP)
bash
Copy
Edit
ipset create blacklist hash:ip
ipset add blacklist 1.2.3.4
iptables -I INPUT -m set --match-set blacklist src -j DROP
üíæ –ü—Ä–∏–º–µ—Ä —Å–∫—Ä–∏–ø—Ç–∞
bash
Copy
Edit
#!/bin/bash

iptables -F
iptables -X
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p tcp --dport 443 -j ACCEPT